version: "0.1"
source_of_truth: "Anna Couling â€” A Complete Guide to Volume Price Analysis (2013)"
do_not_introduce_external_framework_terms: true

shared_parameters:
  vol_avg_window_N: 20
  spread_avg_window_M: 20
  trend_window_K: 5
  setup_window_X: 5
  vol_state_thresholds:
    low_lt: 0.8
    high_gt: 1.2
    ultra_high_gt: 1.8
  spread_state_thresholds:
    narrow_lt: 0.8
    wide_gt: 1.2

context_gates:
  CTX-1:
    name: "Trend-location-first gate"
    requirement: "trendLocation != UNKNOWN"
    applies_to: ["ANOMALY", "PHASE_SIGNAL"]
  CTX-2:
    name: "Dominant alignment risk gate"
    requirement: "dominantAlignment in {WITH, AGAINST}"
  CTX-3:
    name: "Congestion awareness gate"
    requirement: "congestion.active is known"

rules:
  - id: "VAL-1"
    type: "atomic_rule"
    class: "VALIDATION"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: []
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "close > open"
        - "spreadState == WIDE"
        - "volState in {HIGH, ULTRA_HIGH}"
    emits:
      signal_event: "VALIDATION_BULL"
    tests_required:
      - "FXT-VAL-1-basic"

  - id: "ANOM-1"
    type: "atomic_rule"
    class: "ANOMALY"
    direction_bias: "BEARISH_OR_WAIT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "close > open"
        - "spreadState == WIDE"
        - "volState == LOW"
    emits:
      signal_event: "ANOMALY_TRAP_UP_WARNING"
    tests_required:
      - "FXT-ANOM-1-basic"

  - id: "STR-1"
    type: "atomic_rule"
    class: "STRENGTH"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.hammer"
    conditions:
      all:
        - "lower_wick / range >= hammer.lower_wick_ratio_min"
        - "spread / range <= hammer.body_ratio_max"
        - "upper_wick / range <= hammer.upper_wick_ratio_max"
        - "range > 0"
    emits:
      signal_event: "STRENGTH_HAMMER"
    notes: "Hammer candle: session falls then recovers to close near open. Selling absorbed. Powerful with VPA."
    tests_required:
      - "FXT-STR-1-basic"

  - id: "WEAK-1"
    type: "atomic_rule"
    class: "WEAKNESS"
    direction_bias: "BEARISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.shooting_star"
    conditions:
      all:
        - "upper_wick / range >= shooting_star.upper_wick_ratio_min"
        - "spread / range <= shooting_star.body_ratio_max"
        - "lower_wick / range <= shooting_star.lower_wick_ratio_max"
        - "range > 0"
    emits:
      signal_event: "WEAKNESS_SHOOTING_STAR"
    notes: "Shooting star: market pushed higher then falls back. In downtrends confirms weakness; after climax can be test of demand."
    tests_required:
      - "FXT-WEAK-1-basic"

  - id: "ANOM-2"
    type: "atomic_rule"
    class: "ANOMALY"
    direction_bias: "BEARISH_OR_WAIT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "volState in {HIGH, ULTRA_HIGH}"
        - "spreadState in {NARROW, NORMAL}"
    emits:
      signal_event: "ANOMALY_WEAKNESS_OR_ABSORPTION"
    notes: "High effort not producing expected result. Insiders selling/absorbing at this level."
    tests_required:
      - "FXT-ANOM-2-basic"

  - id: "TEST-SUP-1"
    type: "atomic_rule"
    class: "TEST"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "volState == LOW"
        - "spreadState in {NARROW, NORMAL}"
    emits:
      signal_event: "SUPPLY_REMOVED_TEST_PASS"
    notes: "Low-volume bar with narrow/normal spread near congestion. Selling pressure removed."
    tests_required:
      - "FXT-TEST-SUP-1-basic"

setups:
  - id: "ENTRY-LONG-1"
    type: "setup"
    direction: "LONG"
    scope:
      timeframes: ["primary"]
      markets: ["any"]
    gates_required: ["CTX-1", "CTX-3"]
    sequence:
      within_bars: "${shared_parameters.setup_window_X}"
      steps:
        - "TEST-SUP-1"
        - "VAL-1"
    invalidation:
      any:
        - "opposing_high_priority_anomaly"
        - "context_gate_failure"
        - "window_expired"
    emits:
      trade_intent_candidate: "ENTRY_OK_LONG"
    tests_required:
      - "FXT-ENTRY-LONG-1-seq"
