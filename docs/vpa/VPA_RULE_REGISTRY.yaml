version: "0.1"
source_of_truth: "Anna Couling — A Complete Guide to Volume Price Analysis (2013)"
do_not_introduce_external_framework_terms: true

shared_parameters:
  vol_avg_window_N: 20
  spread_avg_window_M: 20
  trend_window_K: 5
  setup_window_X: 5
  vol_state_thresholds:
    low_lt: 0.8
    high_gt: 1.2
    ultra_high_gt: 1.8
  spread_state_thresholds:
    narrow_lt: 0.8
    wide_gt: 1.2

context_gates:
  CTX-1:
    name: "Trend-location-first gate"
    requirement: "trendLocation != UNKNOWN"
    applies_to: ["ANOMALY", "PHASE_SIGNAL"]
  CTX-2:
    name: "Dominant alignment risk gate"
    requirement: "dominantAlignment in {WITH, AGAINST}"
  CTX-3:
    name: "Congestion awareness gate"
    requirement: "congestion.active is known"

rules:
  - id: "VAL-1"
    type: "atomic_rule"
    class: "VALIDATION"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: []
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "close > open"
        - "spreadState == WIDE"
        - "volState in {HIGH, ULTRA_HIGH}"
    emits:
      signal_event: "VALIDATION_BULL"
    tests_required:
      - "FXT-VAL-1-basic"

  - id: "ANOM-1"
    type: "atomic_rule"
    class: "ANOMALY"
    direction_bias: "BEARISH_OR_WAIT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "close > open"
        - "spreadState == WIDE"
        - "volState == LOW"
    emits:
      signal_event: "ANOMALY_TRAP_UP_WARNING"
    tests_required:
      - "FXT-ANOM-1-basic"

  - id: "STR-1"
    type: "atomic_rule"
    class: "STRENGTH"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.hammer"
    conditions:
      all:
        - "lower_wick / range >= hammer.lower_wick_ratio_min"
        - "spread / range <= hammer.body_ratio_max"
        - "upper_wick / range <= hammer.upper_wick_ratio_max"
        - "range > 0"
    emits:
      signal_event: "STRENGTH_HAMMER"
    notes: "Hammer candle: session falls then recovers to close near open. Selling absorbed. Powerful with VPA."
    tests_required:
      - "FXT-STR-1-basic"

  - id: "WEAK-1"
    type: "atomic_rule"
    class: "WEAKNESS"
    direction_bias: "BEARISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.shooting_star"
    conditions:
      all:
        - "upper_wick / range >= shooting_star.upper_wick_ratio_min"
        - "spread / range <= shooting_star.body_ratio_max"
        - "lower_wick / range <= shooting_star.lower_wick_ratio_max"
        - "range > 0"
    emits:
      signal_event: "WEAKNESS_SHOOTING_STAR"
    notes: "Shooting star: market pushed higher then falls back. In downtrends confirms weakness; after climax can be test of demand."
    tests_required:
      - "FXT-WEAK-1-basic"

  - id: "WEAK-2"
    type: "atomic_rule"
    class: "WEAKNESS"
    direction_bias: "BEARISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.shooting_star"
    conditions:
      all:
        - "WEAK-1 candle shape (shooting star geometry)"
        - "volState == LOW"
    emits:
      signal_event: "TEST_DEMAND_CONFIRMED_LOW"
    notes: "Shooting star + LOW volume = no demand. Market pushed higher but no buying interest. More decisive than WEAK-1 alone."
    tests_required:
      - "FXT-WEAK-2-basic"

  - id: "CLIMAX-SELL-1"
    type: "atomic_rule"
    class: "WEAKNESS"
    direction_bias: "BEARISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.shooting_star"
    conditions:
      all:
        - "Shooting star geometry (same thresholds as WEAK-1)"
        - "volState in {HIGH, ULTRA_HIGH}"
    emits:
      signal_event: "SELLING_CLIMAX_TOPPING"
    notes: >
      Single-bar climax detection. Deep upper wick + high volume = smart money
      distributing. Couling: one of the most powerful combinations. Repetition
      counting for full pattern handled by Setup Composer.
    tests_required:
      - "FXT-CLIMAX-SELL-1-basic"

  - id: "ANOM-2"
    type: "atomic_rule"
    class: "ANOMALY"
    direction_bias: "BEARISH_OR_WAIT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "volState in {HIGH, ULTRA_HIGH}"
        - "spreadState in {NARROW, NORMAL}"
    emits:
      signal_event: "ANOMALY_WEAKNESS_OR_ABSORPTION"
    notes: "High effort not producing expected result. Insiders selling/absorbing at this level."
    tests_required:
      - "FXT-ANOM-2-basic"

  - id: "CONF-1"
    type: "atomic_rule"
    class: "CONFIRMATION"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: []
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "candle_type == UP"
        - "volState in {AVERAGE, HIGH, ULTRA_HIGH}"
        - "spreadState in {NORMAL, WIDE}"
    emits:
      signal_event: "POSITIVE_RESPONSE"
    notes: >
      Positive response bar: up bar with visible body and non-low volume.
      Meaningful only when following a strength/test signal (STR-1, etc.)
      via Setup Composer sequencing. Couling: "we wait for the next candle"
      — lack of positive response is not bullish.
    tests_required:
      - "FXT-CONF-1-basic"

  - id: "TEST-SUP-1"
    type: "atomic_rule"
    class: "TEST"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "volState == LOW"
        - "spreadState in {NARROW, NORMAL}"
    emits:
      signal_event: "SUPPLY_REMOVED_TEST_PASS"
    notes: "Low-volume bar with narrow/normal spread near congestion. Selling pressure removed."
    tests_required:
      - "FXT-TEST-SUP-1-basic"

  - id: "AVOID-NEWS-1"
    type: "atomic_rule"
    class: "AVOIDANCE"
    direction_bias: "NEUTRAL"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: []
    parameters_ref: "candle_patterns.long_legged_doji"
    conditions:
      all:
        - "range > 0"
        - "spread / range <= long_legged_doji.body_ratio_max"
        - "upper_wick / range >= long_legged_doji.min_wick_ratio"
        - "lower_wick / range >= long_legged_doji.min_wick_ratio"
        - "volState == LOW"
    emits:
      signal_event: "AVOID_TRADE_WAIT"
    notes: >
      Long-legged doji on LOW volume = manipulation / stop hunting.
      Couling: insiders racking price; we stay out and wait for further candles.
    tests_required:
      - "FXT-AVOID-NEWS-1-basic"

  - id: "TREND-VAL-1"
    type: "trend_rule"
    class: "VALIDATION"
    direction_bias: "BULLISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: []
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "trend == UP"
        - "volume_trend == RISING"
    emits:
      signal_event: "TREND_VALID_UP"
    notes: >
      Couling: validation operates at candle level and trend level; rising
      prices with rising volume validates the move.
    tests_required:
      - "FXT-TREND-VAL-1-basic"

  - id: "TREND-ANOM-1"
    type: "trend_rule"
    class: "ANOMALY"
    direction_bias: "BEARISH_OR_WAIT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "trend == UP"
        - "volume_trend == FALLING"
    emits:
      signal_event: "TREND_ANOM_WEAK_UPTREND"
    notes: >
      Couling: rising markets should be associated with rising volume,
      not falling; alarm bells.
    tests_required:
      - "FXT-TREND-ANOM-1-basic"

  - id: "TEST-SUP-2"
    type: "atomic_rule"
    class: "TEST"
    direction_bias: "BEARISH_OR_WAIT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "shared_parameters"
    conditions:
      all:
        - "volState in {HIGH, ULTRA_HIGH}"
        - "spreadState in {NARROW, NORMAL}"
    emits:
      signal_event: "SUPPLY_TEST_FAIL_RETURN_TO_RANGE"
    notes: >
      Failed test of supply: same bar shape as TEST-SUP-1 but high volume
      means supply is still present. Couling: expect insiders take market
      back into congestion to flush selling pressure, then test again.
    tests_required:
      - "FXT-TEST-SUP-2-basic"

  - id: "TEST-DEM-1"
    type: "atomic_rule"
    class: "TEST"
    direction_bias: "BEARISH"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    parameters_ref: "candle_patterns.shooting_star"
    conditions:
      all:
        - "range > 0"
        - "spread / range <= shooting_star.body_ratio_max"
        - "upper_wick > lower_wick"
        - "volState == LOW"
    emits:
      signal_event: "DEMAND_REMOVED_TEST_PASS"
    notes: >
      Test of demand: market pushed higher but closes back near open on
      very low volume. Couling: safe to start moving market lower, fast.
      Post-distribution signal confirming no buying interest returning.
    tests_required:
      - "FXT-TEST-DEM-1-basic"

setups:
  - id: "ENTRY-LONG-1"
    type: "setup"
    direction: "LONG"
    scope:
      timeframes: ["primary"]
      markets: ["any"]
    gates_required: ["CTX-1", "CTX-3"]
    sequence:
      within_bars: "${shared_parameters.setup_window_X}"
      steps:
        - "TEST-SUP-1"
        - "VAL-1"
    invalidation:
      any:
        - "opposing_high_priority_anomaly"
        - "context_gate_failure"
        - "window_expired"
    emits:
      trade_intent_candidate: "ENTRY_OK_LONG"
    tests_required:
      - "FXT-ENTRY-LONG-1-seq"

  - id: "ENTRY-SHORT-1"
    type: "setup"
    direction: "SHORT"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    sequence:
      within_bars: "${shared_parameters.setup_window_X}"
      steps:
        - "CLIMAX-SELL-1"
        - "WEAK-1 or WEAK-2"
    invalidation:
      any:
        - "opposing_validation_or_strength (VAL-1, STR-1)"
        - "window_expired"
    emits:
      trade_intent_candidate: "ENTRY_OK_SHORT"
    notes: >
      Post-distribution short entry. CLIMAX-SELL-1 identifies smart money
      distributing; WEAK-1/WEAK-2 confirms no demand returning. Stop above
      the climax bar high.
    tests_required:
      - "FXT-ENTRY-SHORT-1-seq"

  - id: "ENTRY-LONG-2"
    type: "setup"
    direction: "LONG"
    scope:
      timeframes: ["any"]
      markets: ["any"]
    gates_required: ["CTX-1"]
    sequence:
      within_bars: "${shared_parameters.setup_window_X}"
      steps:
        - "STR-1"
        - "CONF-1"
    invalidation:
      any:
        - "opposing_high_priority_anomaly"
        - "AVOID-NEWS-1"
        - "window_expired"
    stop_placement: "below hammer wick (first signal bar_low)"
    emits:
      trade_intent_candidate: "ENTRY_OK_LONG"
    notes: "Couling hammer reversal: STR-1 detected, wait for positive response (CONF-1). Stop below hammer wick."
    tests_required:
      - "FXT-ENTRY-LONG-2-seq"
